# Distributed



# 分布式系统



![](01distributed.png)





# 微服务划分



## 单一职责原则



* 每一个微服务只做好一件事,体现出高内聚,低耦合,尽量减少对外界环境的依赖
* 比如,在公司创业之初,完全可将订单与仓储服务进行合并.因为订单与仓储在业务与数据上紧密相关,如果强行拆分会导致出现跨进程通信带来的数据一致性难题.随着业务的发展,仓储的业务职责扩展,派生出许多与订单无紧密联系的功能,到时再将其剥离形成独立的仓储服务



## 服务依赖原则



* 避免服务间的循环引用,在设计时就要对服务进行分级,区分核心服务与非核心服务
* 比如订单服务与短信服务,显然短信服务是非核心服务,服务间调用要遵循核心服务到非核心服务的方向,不允许出现反向调用
* 同时,对于核心服务要做好保护,避免非核心服务出现问题影响核心服务的正常运行



## Two Pizza Team



* 让团队保持在两个比萨能让队员吃饱的小规模的概念
* 团队要小到让每个成员都能做出显著的贡献,并且相互依赖,有共同目标,以及统一的成功标准
* 一个微服务团队应涵盖从设计到发布运维的完整生命周期,使团队内部便可以解决大部分任务,4~6人是比较理想的规模



## 明确微服务使命



* 一套标准的微服务叙述模板,集中体现只做好一件事的原则

  ```
  XX 微服务用来
  在出现痛点场景的情况下
  解决现有的 XX 问题
  从而达到了 XXX 的效果
  体现了微服务的价值
  示例
  商品检索微服务用来
  在商品数据全量多维度组合查询的情况下
  解决了 MySQL 数据库全表扫描查询慢的问题
  从而让查询响应降低到 50ms 以下
  有效提升了用户体验
  ```

* 通过这种描述,服务的职责与边界就十分明确,团队便以此为目标确认职责

* 经过漫长时间沉淀,系统中出现了类似于商品检索服务,订单检索服务等多个小服务,这时可以对这些服务形成聚合生成新的通用检索服务,以此来控制微服务的整体规模

* 对于庞大的服务,可以考虑拆分为多个小服务进行细粒度的管理

* 拆与合是伴随着公司业务的演进而变化的,一切以解决问题为准



## 确保独立的数据存储



* 不同的微服务对数据存储的需求是不同的
* 如订单服务需要 MySQL 数据保存订单与订单明细;新闻服务需要Elasticsearch提供全文检索支持;朋友圈需要图数据库表达现实世界人际关系;文件存储服务则需要分布式文件系统
* 如果将所有数据都揉在 MySQL 中使用会变得十分蹩脚,应该为每个微服务提供符合自身业务特性的数据库



## 服务间通信



* 优先采用聚合器模式.在微服务间通信时存在两种消息传递模式:链式模式与聚合器模式
* 链式模式:请求按业务流程传递,采用串联模式,调用的整体成功率等于单个服务成功率的乘积
* 假设每个服务可靠性为 90%,一个业务在 4 个服务执行后的最终成功率只有 90%*90%*90%*90%≈66%,有将近一半的请求会处理失败
* 链式模式因默认采用同步方式传输,在服务处理完成前应用会一直处于阻塞状态,当调用链较长时,系统整体性能会严重下滑
* 聚合器模式则是通过服务作为入口,组装其他服务的调用
* 以订单流程服务为例,将订单,支付,库存服务进行聚合,一个服务实现了下单,支付,减库存的完整流程





## 不要强行微服务化



* 微服务也不过是一种方案,没必要盲从.它也没有违背架构的基本规律:架构是解决当前需求和痛点而演进的,在满足需要的前提下,选择合适的而不是选择最好的,合理降低成本才是好架构师该考虑的事情



# 应用场景



* 新规划的大型业务系统
* 敏捷的小团队系统
* 历史的大型留存业务系统.重构时可以将某一个部分剥离为微服务独立运行,确保无误后再继续剥离出下一个服务,逐步将原有大系统剥离为若干子服务
* 微型项目,系统压力很小,需求变化也不大,使用分布式反而增加了复杂度,不适合使用微服务
* 对数据响应要求高的系统,不适合微服务



# 分布式支付系统(Dubbo)



![](02支付.png)



## 应用架构



* 服务子系统:账户,交易,对账,结算,打款,风控……
* 内部管理应用:运营,风控,会计……
* 对外业务应用:门户,代理商系统……
* 对外接入应用:网关,前置,交易接口……
* 定时任务应用:结算,日终,统计分析……
* 其它应用:对账,消息队列处理……
* 服务子系统:Dubbo服务提供者
* 其它类型的应用:Dubbo服务消费者



## 系统架构



* 消息队列:RocketMQ,RabbitMQ,Kafka
* 分布式缓存:Redis
* 分布式文件系统:FastDFS,HDFS
* 反向代理服务器:Nginx
* 集群与负载均衡:Keepalived,HAproxy,LVS
* 应用服务器:Tomcat
* 数据库:MySQL,Oracle
* 数据库分布式处理系统(集群,分库,分表):MyCat
* 容器引擎:Docker,K8S
* 系统日志管理:ELK
* 分布式系统监控:Zabbix
* 其它:CA证书,密码键盘,防篡改系统……
* 高可用,高性能,可扩展,便于运维管理,符合系统检测要求……



# 金融借贷



![](03金融借贷.png)



# 京东商城



![](04京东商城.png)